---
title: "Compulsory Exercise 2: Prediction of Alzheimers Disease from Longitudinal MRI Data"
author:
- Chester Henry Charlton
- Kasper Eikeland
- Tinus Garshol
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes: \usepackage{amsmath}
output:
  html_document:
  #   toc: no
  #   toc_depth: '2'
  #   df_print: paged
  #pdf_document:
    toc: no
    toc_depth: '2'
urlcolor: blue
abstract: "While Alzheimer's disease is traditionally diagnosed by medical professionals, in this report we detail the use of statistical learning models to classify Alzheimer's disease. Cross-sectional and Longitudinal MRI data was used from a mix of nondemented and demented patients. This data also included several non-MRI features, such as assessments by medical professionals, education level, and the final diagnosis, which was used as a target variable for the models. The primary models tested were decision trees(?) using the random forest method, support vector machines, and logistic regression. Support vector machines and decision trees were chosen based on applicability, and logistic regression was chosen due to its relevance and consistent use in the mdeical field. [sentence describing results - we don't have this yet]. While the significance of this report was lessened in ambition by the lack of data for patients who were converted from nondemented to demented, it still holds value as a way for screening patients without the assistance of a doctor, and in the more explainable models provides a way to determine the relative importance of variables in relation to Alzheimer's disease. Furthermore, by applying our models both to the corss-sectional and longitudinal data, we can make some conclusions about the efficacy in temporal data in classifying Alzheimer's disease."
---

```{r setup, include=FALSE}
library("knitr")
knitr::opts_chunk$set(echo=TRUE, eval=TRUE, message=FALSE, warning = FALSE, 
                      strip.white = TRUE, prompt = FALSE, cache = TRUE, 
                      size = "scriptsize", fig.width = 4, fig.height = 3,
                      fig.align = "center")

```

```{r,eval=TRUE,echo=FALSE}
library("rmarkdown")
library("dplyr")
library("GGally")
library("tidyr")
library("formatR")
```

## The block below is specific to Henry's Computer
```{r}
#specific to Henry's computer
setwd("/Users/chcharlton/NTNU/statLearning/tma4268_alzheimers")
```

## The block below is universal, each groupmember will use it build from
```{r}
cross_sectional.df <- read.csv("oasis_cross-sectional.csv")
# Patient is demented if CDR is > 0
cs.mutated <- cross_sectional.df %>%
  dplyr::select(c(M.F, eTIV, MMSE, nWBV, ASF, Age, CDR)) %>%
  na.omit() %>%
  mutate(Demented = as.factor(CDR>0),
         M.F = as.factor(M.F)) %>%
  dplyr::select(c(M.F, eTIV, MMSE, nWBV, ASF, Age, Demented))
longitudinal.df <- read.csv("oasis_longitudinal.csv")
longitudinal_deltas <- longitudinal.df %>% 
  group_by(Subject.ID) %>%
  summarise(dMMSE = (last(MMSE) - first(MMSE)) / last(Visit), 
            deTIV = (last(eTIV) - first(eTIV)) / last(Visit),
            dnWBV = (last(nWBV) - first(nWBV)) / last(Visit),
            dASF = (last(ASF) - first(ASF)) / last(Visit),
            dAge = (last(Age) - first(Age)) / last(Visit))
baseline_with_deltas <- longitudinal.df %>%
  filter(Visit == 1) %>%
  left_join(longitudinal_deltas, by = c("Subject.ID")) %>%
  mutate(Demented = as.factor(Group != "Nondemented"), # Those who converted became demented
         M.F = as.factor(M.F)) %>% 
  dplyr::select(-c(Subject.ID, MRI.ID, Group, Visit, MR.Delay, Hand, CDR, SES)) 
  
set.seed(1337)
# Longitudinal data
l.train.indices <- sample(1:nrow(baseline_with_deltas), floor(.75 * nrow(baseline_with_deltas)))
longitudinal.train <- na.omit(baseline_with_deltas[l.train.indices,])
longitudinal.test <- na.omit(baseline_with_deltas[-l.train.indices,])
# Cross-sectional
cs.train.indices <- sample(1:nrow(cs.mutated), floor(.75 * nrow(cs.mutated)))
cs.train <- na.omit(cs.mutated[cs.train.indices,])
cs.test <- na.omit(cs.mutated[-cs.train.indices,])
```

## Logistic regression

```{r}
# logistic regression on longitudinal data
longitudinal.logistic <-  glm(Demented ~ . - dMMSE - MMSE, data = longitudinal.train, family = binomial)
longitudinal.logistic.probs <- predict(longitudinal.logistic, newdata = longitudinal.test, type = "response")
longitudinal.logistic.pred <- ifelse(longitudinal.logistic.probs > 0.5, 1, 0)

longitudinal.logistic.confusion <- table(longitudinal.logistic.pred, longitudinal.test$Demented)
rownames(longitudinal.logistic.confusion) <- c('pred 0','pred 1')
colnames(longitudinal.logistic.confusion) <- c('true 0','true 1')

longitudinal.logistic.sens <- longitudinal.logistic.confusion[2,2] / sum(longitudinal.logistic.confusion[,2])
longitudinal.logistic.spec <- longitudinal.logistic.confusion[1,1] / sum(longitudinal.logistic.confusion[,1])
longitudinal.logistic.vals = c(longitudinal.logistic.sens, longitudinal.logistic.spec)

longitudinal.logistic.confusion
longitudinal.logistic.vals

```
longitudinal logistic regression on all variables: 

longitudinal.logistic.pred true 0 true 1
                    pred 0     15      4
                    pred 1      1     17
[1] 0.8095238 0.9375000
     (sens)     (spec)
 
longitudinal logistic regression on all variables except deltas: 

longitudinal.logistic.pred true 0 true 1
                    pred 0     15      8
                    pred 1      1     13
[1] 0.6190476 0.9375000
     (sens)    (spec)


```{r}
# logistic regression on cross-sectional data
cs.logistic <-  glm(Demented ~ ., data = cs.train, family = binomial)
cs.logistic.probs <- predict(cs.logistic, newdata = cs.test, type = "response")
cs.logistic.pred <- ifelse(cs.logistic.probs > 0.5, 1, 0)

cs.logistic.confusion <- table(cs.logistic.pred, cs.test$Demented)
rownames(cs.logistic.confusion) <- c('pred 0','pred 1')
colnames(cs.logistic.confusion) <- c('true 0','true 1')

cs.logistic.sens <- cs.logistic.confusion[2,2] / sum(cs.logistic.confusion[,2])
cs.logistic.spec <- cs.logistic.confusion[1,1] / sum(cs.logistic.confusion[,1])
cs.logistic.vals = c(cs.logistic.sens, cs.logistic.spec)

cs.logistic.confusion
cs.logistic.vals
```


Note: The sensitivity for our cross-sectional logistic model is terrible compared to the longitudinal logistic model. I hypothesize that this is due to the lack of temporal data. To test this I removed the deltas and this resulted in a MUCH worse performance, indicating that my hypothesis was at least partially correct. 






## Introduction: Scope and purpose of your project


## Descriptive data analysis/statistics

### Description of Features:

Group: The group that the patient was classified in at the across the various scans. Possible values are "Undemented," denoting a patient without symptoms of dementia throughout all scans, "Demented" denoting a patient with symptoms of dementia across all scans, or "Converted," denoting someone who began without symptoms of dementia but developed them at a further scan.

Visit: The order of the visit in which the scan was done, indexed from 1.

MR Delay: The number of days since the previous scan. Marked as 0 for the initial scan.

M.F: Categorical variable for male or female patients at birth. M denotes male, F denotes female.

Hand: The patient's dominant hand. All of the patients were right-handed.

EDUC: The education level of the patient, measured in years (including elementary school).

SES: "Socioeconomic status as assessed by the Hollingshead Index of Social Position and classified into categories from 1 (highest status) to 5 (lowest status) (Hollingshead, 1957)"

MMSE: "Mini-Mental State Examination score (range is from 0 = worst to 30 = best) (Folstein, Folstein, & McHugh, 1975)"

CDR: "Clinical Dementia Rating (0 = no dementia, 0.5 = very mild AD, 1 = mild AD, 2 = moderate AD) (Morris, 1993)"

ASF: "Atlas scaling factor (unitless). Computed scaling factor that transforms native-space brain and skull to the atlas target (i.e., the determinant of the transform matrix) (Buckner et al., 2004)"

eTIV: "Estimated total intracranial volume (cm3) (Buckner et al., 2004)"

nWBV: "Normalized whole-brain volume, expressed as a percent of all voxels in the atlas-masked image that are labeled as gray or white matter by the automated tissue segmentation process (Fotenos et al., 2005)"



## Methods


## Results and interpretation

### points to discuss:

whether to include MMSE: Seems like it is objective, and only takes a few minutes to run. It could theoretically be run by existing NLP structures, so we could make an argument that using this does not compromise our goal of eliminating pressure on medical professionals. 

whether having an high specificity or sensitivity is more important: what is worse: (1) someone who truly does not have alzheimer's being told they do, or (2) someone who truly does have alzheimer's being told they don't? If (1): 




## Summary
